<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Asistente Megafy ‚Äî Diagn√≥stico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ChatKit Web Component -->
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" defer></script>

  <style>
    :root { --w: 900px; }
    body {
      font-family: system-ui, sans-serif;
      margin: 0; padding: 20px; background: #f8f9fa; color: #222;
      display: flex; flex-direction: column; align-items: center; min-height: 100vh;
    }
    header {
      width: 100%; max-width: var(--w);
      display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
    }
    header img { height: 48px; }
    header h1 { font-size: 1.4rem; margin: 0; }
    #diag {
      width: 100%; max-width: var(--w);
      background: #fff; border: 1px solid #ddd; border-radius: 8px;
      padding: 10px; margin: 10px 0; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      white-space: pre-wrap; word-break: break-word; font-size: 12px; color: #333;
    }
    openai-chatkit {
      width: 100%; max-width: var(--w); height: 600px; display: block;
      border-radius: 12px; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden; background: #fff;
    }
    footer { text-align: center; font-size: 12px; color: #666; margin-top: 10px; }
  </style>
</head>
<body>
  <header>
    <img src="https://megafy.net/wp-content/uploads/2022/06/logo-megafy-footer.png" alt="Logo Megafy" />
    <h1>Asistente Megafy ‚Äî Diagn√≥stico</h1>
  </header>

  <div id="diag">Iniciando diagn√≥stico‚Ä¶</div>

  <openai-chatkit id="chat"></openai-chatkit>

  <footer>Desarrollado con OpenAI ChatKit</footer>

  <script type="module">
    const $d = document.getElementById('diag');
    const log = (...a) => {
      console.log(...a);
      $d.textContent += '\n' + a.map(x => typeof x === 'string' ? x : JSON.stringify(x, null, 2)).join(' ');
    };
    const step = t => $d.textContent += '\n\n‚Äî ' + t + ' ‚Äî';

    window.addEventListener('error', e => log('JS error:', e.message));
    window.addEventListener('unhandledrejection', e => log('Promise rejection:', e.reason));

    window.addEventListener('load', async () => {
      try {
        step('1) Registro del web component');
        if (!customElements.get('openai-chatkit')) {
          log('Esperando customElements.whenDefined("openai-chatkit")‚Ä¶');
          await customElements.whenDefined('openai-chatkit');
        }
        log('openai-chatkit definido:', !!customElements.get('openai-chatkit'));

        step('2) Comprobaci√≥n de elemento en el DOM');
        const chat = document.getElementById('chat');
        if (!chat) { log('‚ùå No existe #chat'); return; }
        log('Elemento #chat:', chat.tagName, 'shadowRoot?', !!chat.shadowRoot);

        step('3) Petici√≥n de token a /api/chatkit/start');
        let tokenJSON = null;
        try {
          const r = await fetch('/api/chatkit/start', { method: 'POST' });
          log('start status:', r.status);
          const text = await r.text();
          log('start raw response:', text);
          try { tokenJSON = JSON.parse(text); } catch(e) { log('‚ö†Ô∏è Respuesta no-JSON'); }
          if (!r.ok) { log('‚ùå start no-OK'); return; }
          if (!tokenJSON?.client_secret) { log('‚ùå Falta client_secret'); return; }
          log('‚úÖ client_secret recibido (truncado):', tokenJSON.client_secret.slice(0, 12) + '‚Ä¶');
        } catch (err) {
          log('‚ùå Error fetch /api/chatkit/start:', err);
          return;
        }

        step('4) ¬øExiste setOptions? ¬øExiste la propiedad options?');
        log('typeof chat.setOptions:', typeof chat.setOptions);
        log('Tiene descriptor "options"?', 'options' in chat);

        step('5) Asignaci√≥n de opciones');
        const OPTIONS = {
          api: {
            async getClientSecret(existing) {
              if (!existing) return tokenJSON.client_secret;
              // refresh opcional
              const rr = await fetch('/api/chatkit/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentClientSecret: existing })
              });
              const td = await rr.json().catch(() => ({}));
              return td?.client_secret || existing;
            }
          },
          locale: 'es-ES',
          theme: {
            colorScheme: 'light',
            color: { accent: { primary: '#0078ff', level: 2 } },
            radius: 'round',
            density: 'normal'
          },
          composer: { placeholder: 'Escribe tu consulta‚Ä¶' },
          startScreen: {
            greeting: 'üëã ¬°Hola! Soy el asistente de Megafy. ¬øEn qu√© puedo ayudarte?',
            prompts: [
              { name: 'Servicios', prompt: '¬øQu√© servicios ofrece Megafy?', icon: 'info' },
              { name: 'Soporte',   prompt: 'Necesito soporte t√©cnico.',   icon: 'bolt' },
              { name: 'Planes',    prompt: '¬øQu√© planes o precios ofrecen?', icon: 'search' }
            ]
          }
        };

        if (typeof chat.setOptions === 'function') {
          log('Usando chat.setOptions(OPTIONS)‚Ä¶');
          chat.setOptions(OPTIONS);
        } else {
          log('Usando asignaci√≥n chat.options = OPTIONS‚Ä¶');
          chat.options = OPTIONS;
        }

        step('6) Eventos del widget');
        chat.addEventListener('chatkit.ready', () => log('‚úÖ chatkit.ready'));
        chat.addEventListener('chatkit.error', (evt) => log('‚ùå chatkit.error:', evt.detail || evt));
        chat.addEventListener('chatkit.state', (evt) => log('‚ÑπÔ∏è chatkit.state:', evt.detail || evt));

        // Verificaci√≥n final tras un peque√±o delay
        setTimeout(() => {
          log('Estado final: typeof chat.setOptions =', typeof chat.setOptions, ' | options asignadas?', !!chat.options);
          log('Si no ves "chatkit.ready" arriba y no hay errores, revisa allowlist del dominio en el agente y CSP del sitio.');
        }, 1200);
      } catch (e) {
        log('‚ùå Error general:', e?.message || e);
      }
    });
  </script>
</body>
</html>
