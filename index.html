<script type="module">
  window.addEventListener('load', async () => {
    await customElements.whenDefined('openai-chatkit');

    async function getClientSecret(existing) {
      const endpoint = existing ? "/api/chatkit/refresh" : "/api/chatkit/start";
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: existing ? JSON.stringify({ currentClientSecret: existing }) : null
      });
      if (!res.ok) throw new Error(`Token ${res.status}: ${await res.text()}`);
      const { client_secret } = await res.json();
      if (!client_secret) throw new Error("Respuesta sin client_secret");
      return client_secret;
    }

    const chat = document.getElementById("chat");

    // ðŸš« IMPORTANTE: nada de setOptions aquÃ­.
    chat.options = {
      api: { getClientSecret },
      locale: "es-ES",
      theme: {
        colorScheme: "light",
        color: { accent: { primary: "#0078ff", level: 2 } },
        radius: "round",
        density: "normal"
      },
      composer: { placeholder: "Escribe tu consultaâ€¦" },
      startScreen: {
        greeting: "ðŸ‘‹ Â¡Hola! Soy el asistente de Megafy. Â¿En quÃ© puedo ayudarte?",
        prompts: [
          { name: "Servicios", prompt: "Â¿QuÃ© servicios ofrece Megafy?", icon: "info" },
          { name: "Soporte", prompt: "Necesito soporte tÃ©cnico.", icon: "bolt" },
          { name: "Planes",  prompt: "Â¿QuÃ© planes o precios ofrecen?", icon: "search" }
        ]
      }
    };

    chat.addEventListener('chatkit.error', (evt) => {
      console.error('ChatKit error:', evt.detail?.error || evt);
    });
  });
</script>
